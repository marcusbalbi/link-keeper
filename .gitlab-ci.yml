image: docker:19.03.0

stages:
  - build
  - lint
  - test
  - docker
  - notification

cache:
  paths:
  - node_modules/
  
install_dependencies:
  image: node:latest
  stage: build
  tags:
    - link-keeper-executor
  script:
    - npm install

lint:
  image: node:latest
  stage: lint
  tags:
    - link-keeper-executor
  script:
    - npm run lint
  dependencies: 
    - install_dependencies

integration_test:
  services:
    - mongo:latest
  image: node:latest
  stage: test
  variables:
    PORT: $PORT
    LINK_ENCRYPT_KEY: $LINK_ENCRYPT_KEY
    MONGO_HOST: $MONGO_HOST
    MONGO_PORT: $MONGO_PORT
    MONGO_DATABASE_NAME: 'link_keeper_integration_test'
  tags:
    - link-keeper-executor
  script:
    - echo $CI_JOB_STAGE # calls a predefined variable
    - echo $LINK_ENCRYPT_KEY # calls a custom variable of type `env_var`
    - echo $MONGO_HOST # calls a custom variable of type `file` that contains the path to the temp file
    - echo $MONGO_PORT # the temp file itself contains the variable value

  dependencies: 
    - install_dependencies

#build-docker-image:
#  services:
#    - docker:19.03.0-dind
#    - mongo:latest
#  before_script:
#    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.gitlab.com
#  stage: docker
#  variables:
#    PORT: $PORT
#    LINK_ENCRYPT_KEY: $LINK_ENCRYPT_KEY
#    MONGO_HOST: $MONGO_HOST
#    MONGO_PORT: $MONGO_PORT
#    MONGO_DATABASE_NAME: $MONGO_DATABASE_NAME
#    MONGO_INITDB_ROOT_USERNAME: $MONGO_INITDB_ROOT_USERNAME
#    MONGO_INITDB_ROOT_PASSWORD: $MONGO_INITDB_ROOT_PASSWORD
#  tags:
#    - link-keeper-executor
#  script:
#    - docker build -f .docker/Dockerfile -t registry.gitlab.com/marcusbalbi/link-keeper-server .
#    - docker tag registry.gitlab.com/marcusbalbi/link-keeper-server registry.gitlab.com/marcusbalbi/link-keeper-server:latest
#    - docker push registry.gitlab.com/marcusbalbi/link-keeper-server:latest

notification-success:
    stage: notification
    tags:
    - link-keeper-executor-deploy
    when: on_success
    script:
    - echo "tudo deu certo"

notification-failed:
    stage: notification
    tags:
    - link-keeper-executor-deploy
    when: on_failure
    script:
    - echo "deu errado"